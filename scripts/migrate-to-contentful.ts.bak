/**
 * MDX íŒŒì¼ì„ Contentfulë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
 *
 * ì‹¤í–‰ ë°©ë²•:
 * npx tsx scripts/migrate-to-contentful.ts
 *
 * ì˜µì…˜:
 * --dry-run : ì‹¤ì œ ì—…ë¡œë“œ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°
 * --limit=10 : ì²˜ìŒ Nê°œë§Œ ë§ˆì´ê·¸ë ˆì´ì…˜
 */

import { createClient } from 'contentful-management'
import * as dotenv from 'dotenv'
import { resolve } from 'path'
import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
dotenv.config({ path: resolve(process.cwd(), '.env.local') })

const SPACE_ID = process.env.CONTENTFUL_SPACE_ID!
const MANAGEMENT_TOKEN = process.env.CONTENTFUL_MANAGEMENT_TOKEN!
const ENVIRONMENT = process.env.CONTENTFUL_ENVIRONMENT || 'master'

// CLI ì¸ì íŒŒì‹±
const args = process.argv.slice(2)
const isDryRun = args.includes('--dry-run')
const limitArg = args.find((arg) => arg.startsWith('--limit='))
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : undefined

interface BlogPost {
  slug: string
  title: string
  content: string
  publishedAt: string
  author?: string
  thumbnail?: string | null
  originalCategory?: string
  categories?: string[]
  originalId?: string
  filePath: string
}

// ë‚ ì§œ ë¬¸ìì—´ì„ ISO 8601 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function parseDate(dateStr: string): string {
  if (!dateStr) return new Date().toISOString()

  // ì´ë¯¸ ISO í˜•ì‹ì¸ ê²½ìš°
  if (dateStr.includes('T') && dateStr.includes('Z')) {
    return dateStr
  }

  // "2024-11-01 18:00:20" í˜•ì‹ ì²˜ë¦¬
  const parsed = new Date(dateStr)
  if (!isNaN(parsed.getTime())) {
    return parsed.toISOString()
  }

  // íŒŒì‹± ì‹¤íŒ¨ ì‹œ í˜„ì¬ ì‹œê°„
  return new Date().toISOString()
}

// MDX íŒŒì¼ ì½ê¸° ë° íŒŒì‹±
function readMdxFiles(dir: string): BlogPost[] {
  const files = fs.readdirSync(dir)
  const posts: BlogPost[] = []

  for (const file of files) {
    if (!file.endsWith('.mdx') && !file.endsWith('.md')) continue

    const filePath = path.join(dir, file)
    const fileContent = fs.readFileSync(filePath, 'utf-8')
    const { data, content } = matter(fileContent)

    posts.push({
      slug: data.slug || path.basename(file, path.extname(file)),
      title: data.title || 'Untitled',
      content: content.trim(),
      publishedAt: parseDate(data.publishedAt),
      author: data.author || 'We Do Soft',
      thumbnail: data.thumbnail || null,
      originalCategory: data.originalCategory || '',
      categories: data.categories || [],
      originalId: data.meta?.originalId || data.slug,
      filePath,
    })
  }

  return posts
}

// Contentfulì— í¬ìŠ¤íŠ¸ ì—…ë¡œë“œ
async function uploadToContentful(posts: BlogPost[]) {
  const client = createClient({
    accessToken: MANAGEMENT_TOKEN,
  })

  const space = await client.getSpace(SPACE_ID)
  const environment = await space.getEnvironment(ENVIRONMENT)

  let successCount = 0
  let skipCount = 0
  let errorCount = 0

  for (const [index, post] of posts.entries()) {
    try {
      console.log(`\n[${index + 1}/${posts.length}] ì²˜ë¦¬ ì¤‘: ${post.title}`)
      console.log(`  Slug: ${post.slug}`)
      console.log(`  íŒŒì¼: ${path.basename(post.filePath)}`)

      if (isDryRun) {
        console.log('  âœ“ [DRY RUN] ì—…ë¡œë“œ ìŠ¤í‚µ')
        continue
      }

      // ê¸°ì¡´ ì—”íŠ¸ë¦¬ í™•ì¸ (slugë¡œ ê²€ìƒ‰)
      const existingEntries = await environment.getEntries({
        content_type: 'blogPost',
        'fields.slug': post.slug,
        limit: 1,
      })

      if (existingEntries.items.length > 0) {
        console.log('  âš ï¸  ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í¬ìŠ¤íŠ¸ (ìŠ¤í‚µ)')
        skipCount++
        continue
      }

      // ìƒˆ ì—”íŠ¸ë¦¬ ìƒì„±
      const entry = await environment.createEntry('blogPost', {
        fields: {
          title: { 'en-US': post.title },
          slug: { 'en-US': post.slug },
          content: { 'en-US': post.content },
          publishedAt: { 'en-US': post.publishedAt },
          author: { 'en-US': post.author || 'We Do Soft' },
          thumbnail: post.thumbnail ? { 'en-US': post.thumbnail } : undefined,
          originalCategory: post.originalCategory
            ? { 'en-US': post.originalCategory }
            : undefined,
          categories: post.categories?.length
            ? { 'en-US': post.categories }
            : undefined,
          originalId: post.originalId ? { 'en-US': post.originalId } : undefined,
        },
      })

      // ë°œí–‰
      await entry.publish()
      console.log('  âœ… ì—…ë¡œë“œ ë° ë°œí–‰ ì™„ë£Œ')
      successCount++

      // Rate limit ë°©ì§€ (1ì´ˆ ëŒ€ê¸°)
      await new Promise((resolve) => setTimeout(resolve, 1000))
    } catch (error: any) {
      console.error(`  âŒ ì˜¤ë¥˜: ${error.message}`)
      errorCount++
    }
  }

  return { successCount, skipCount, errorCount }
}

// ë©”ì¸ ì‹¤í–‰
async function main() {
  console.log('ğŸš€ MDX â†’ Contentful ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘\n')
  console.log('ì„¤ì •:')
  console.log(`  Space ID: ${SPACE_ID}`)
  console.log(`  Environment: ${ENVIRONMENT}`)
  console.log(`  Dry Run: ${isDryRun ? 'YES' : 'NO'}`)
  console.log(`  Limit: ${limit || 'ì „ì²´'}`)
  console.log('')

  // 1. MDX íŒŒì¼ ì½ê¸°
  const contentDir = resolve(process.cwd(), 'content/blog')
  console.log(`ğŸ“‚ ë””ë ‰í† ë¦¬: ${contentDir}`)

  if (!fs.existsSync(contentDir)) {
    console.error('âŒ content/blog ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    process.exit(1)
  }

  let posts = readMdxFiles(contentDir)
  console.log(`ğŸ“ ë°œê²¬ëœ í¬ìŠ¤íŠ¸: ${posts.length}ê°œ\n`)

  // Limit ì ìš©
  if (limit) {
    posts = posts.slice(0, limit)
    console.log(`âš¡ ì²˜ìŒ ${limit}ê°œë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.\n`)
  }

  if (posts.length === 0) {
    console.log('ì²˜ë¦¬í•  í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.')
    return
  }

  // 2. Contentful ì—…ë¡œë“œ
  const { successCount, skipCount, errorCount } = await uploadToContentful(posts)

  // 3. ê²°ê³¼ ìš”ì•½
  console.log('\n' + '='.repeat(50))
  console.log('ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ')
  console.log('='.repeat(50))
  console.log(`âœ… ì„±ê³µ: ${successCount}ê°œ`)
  console.log(`âš ï¸  ìŠ¤í‚µ: ${skipCount}ê°œ`)
  console.log(`âŒ ì‹¤íŒ¨: ${errorCount}ê°œ`)
  console.log(`ğŸ“¦ ì „ì²´: ${posts.length}ê°œ`)
  console.log('='.repeat(50))

  if (!isDryRun) {
    console.log('\në‹¤ìŒ ë‹¨ê³„:')
    console.log('1. Contentful ì›¹ UIì—ì„œ í™•ì¸')
    console.log(`   https://app.contentful.com/spaces/${SPACE_ID}/entries`)
    console.log('2. ë¸”ë¡œê·¸ í˜ì´ì§€ API ì—°ë™')
    console.log('   app/blog/page.tsx ìˆ˜ì •')
  }
}

// ì‹¤í–‰
main().catch((error) => {
  console.error('ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error)
  process.exit(1)
})
