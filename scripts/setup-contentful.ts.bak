/**
 * Contentful Content Model ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 *
 * ì‹¤í–‰ ë°©ë²•:
 * npx tsx scripts/setup-contentful.ts
 */

import { createClient } from 'contentful-management'
import * as dotenv from 'dotenv'
import { resolve } from 'path'

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
dotenv.config({ path: resolve(process.cwd(), '.env.local') })

const SPACE_ID = process.env.CONTENTFUL_SPACE_ID!
const MANAGEMENT_TOKEN = process.env.CONTENTFUL_MANAGEMENT_TOKEN!
const ENVIRONMENT = process.env.CONTENTFUL_ENVIRONMENT || 'master'

async function setupContentModel() {
  console.log('ğŸš€ Contentful Content Model ìƒì„± ì‹œì‘...\n')

  // 1. Management Client ìƒì„±
  const client = createClient({
    accessToken: MANAGEMENT_TOKEN,
  })

  try {
    // 2. Spaceì™€ Environment ê°€ì ¸ì˜¤ê¸°
    const space = await client.getSpace(SPACE_ID)
    console.log(`âœ… Space ì—°ê²°: ${space.name}`)

    const environment = await space.getEnvironment(ENVIRONMENT)
    console.log(`âœ… Environment ì—°ê²°: ${ENVIRONMENT}\n`)

    // 3. Blog Post Content Type ìƒì„±
    console.log('ğŸ“ Blog Post Content Type ìƒì„± ì¤‘...')

    const blogPostContentType = await environment.createContentTypeWithId('blogPost', {
      name: 'Blog Post',
      displayField: 'title',
      description: 'ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸',
      fields: [
        {
          id: 'title',
          name: 'ì œëª©',
          type: 'Text',
          required: true,
          localized: false,
          validations: [
            {
              size: { min: 1, max: 200 }
            }
          ]
        },
        {
          id: 'slug',
          name: 'ìŠ¬ëŸ¬ê·¸',
          type: 'Symbol',
          required: true,
          localized: false,
          validations: [
            {
              unique: true
            },
            {
              regexp: {
                pattern: '^[a-zA-Z0-9-_]+$'
              }
            }
          ]
        },
        {
          id: 'content',
          name: 'ë³¸ë¬¸',
          type: 'Text',
          required: true,
          localized: false
        },
        {
          id: 'publishedAt',
          name: 'ë°œí–‰ì¼',
          type: 'Date',
          required: true,
          localized: false
        },
        {
          id: 'author',
          name: 'ì‘ì„±ì',
          type: 'Symbol',
          required: false,
          localized: false
        },
        {
          id: 'thumbnail',
          name: 'ì¸ë„¤ì¼ URL',
          type: 'Symbol',
          required: false,
          localized: false
        },
        {
          id: 'originalCategory',
          name: 'ì›ë³¸ ì¹´í…Œê³ ë¦¬',
          type: 'Symbol',
          required: false,
          localized: false
        },
        {
          id: 'categories',
          name: 'ì¹´í…Œê³ ë¦¬',
          type: 'Array',
          required: false,
          localized: false,
          items: {
            type: 'Symbol',
            validations: []
          }
        },
        {
          id: 'originalId',
          name: 'ì›ë³¸ ID',
          type: 'Symbol',
          required: false,
          localized: false
        }
      ]
    })

    console.log('âœ… Blog Post Content Type ìƒì„± ì™„ë£Œ')

    // 4. Content Type ë°œí–‰
    console.log('ğŸ“¤ Content Type ë°œí–‰ ì¤‘...')
    await blogPostContentType.publish()
    console.log('âœ… Content Type ë°œí–‰ ì™„ë£Œ\n')

    console.log('ğŸ‰ Contentful Content Model ì„¤ì • ì™„ë£Œ!')
    console.log('\në‹¤ìŒ ë‹¨ê³„:')
    console.log('1. Contentful ì›¹ UIì—ì„œ Content Model í™•ì¸')
    console.log('   https://app.contentful.com/spaces/' + SPACE_ID + '/content_types')
    console.log('2. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰')
    console.log('   npx tsx scripts/migrate-to-contentful.ts\n')

  } catch (error: any) {
    if (error.message?.includes('already exists')) {
      console.log('â„¹ï¸  Content Typeì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.')
      console.log('   ê¸°ì¡´ Content Typeì„ ì‚¬ìš©í•˜ê±°ë‚˜, Contentful UIì—ì„œ ì‚­ì œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.')
    } else {
      console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error.message)
      throw error
    }
  }
}

// ì‹¤í–‰
setupContentModel().catch((error) => {
  console.error('ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error)
  process.exit(1)
})
